# Maintainer: Batuhan Baserdem <baserdem.batuhan@gmail.com>
# vim: ft=PKGBUILD
pkgname=sbp-uefi
pkgver=4.0
pkgrel=2
pkgdesc="SBP Meta Package: UEFI-booting"
arch=('any')
url="https://github.com/bbaserdem/Etcfiles"
licence=(MIT)
validpgpkeys=('0B7151C823559DD8A7A04CE36426139E2F4C6CCE')
provides=('sbp-boot')
conflicts=('sbp-bios')
source=(
    'uefi.install'
    'uefi.refind-config'
    'uefi.refind-hook')
sha256sums=(SKIP SKIP SKIP)

package() {
    install=uefi.install

    # Install refind config
    install -dm 0755 "${pkgdir}/boot/efi/EFI/rEFInd"
    install -Dm 0755 uefi.refind-config \
        "${pkgdir}/boot/efi/EFI/rEFInd/refind.conf"

    # Install update hooks
    install -dm 0755 "${pkgdir}/usr/share/libalpm/hooks"
    install -Dm 0755 uefi.refind-hook \
        "${pkgdir}/usr/share/libalpm/hooks/99-refind-sb.hook"

    # Create directory for storing secure-boot keys, and symlink with names
    install -dm 0755 "${pkgdir}/etc"
    install -dm 0700 "${pkgdir}/etc/sbkeys"
    install -dm 0755 "${pkgdir}/etc/refind.d"
    install -dm 0700 "${pkgdir}/etc/refind.d/keys"
    ln -sf "/etc/sbkeys/db.key" "${pkgdir}/etc/refind.d/keys/refind_local.key"
    ln -sf "/etc/sbkeys/db.esl" "${pkgdir}/etc/refind.d/keys/refind_local.esl"
    ln -sf "/etc/sbkeys/db.crt" "${pkgdir}/etc/refind.d/keys/refind_local.crt"
    ln -sf "/etc/sbkeys/db.cer" "${pkgdir}/etc/refind.d/keys/refind_local.cer"

    depends=(
        'efibootmgr'            # Write to bios
        'efitools'              # EFI manip tools
        'sbsigntools'           # To sign kernels
        'openssl'               # For signing
        'sbupdate'              # Signs kernel automatically
        'refind-efi'            # Refind loader
        'refind-theme-regular'  # Theming refind
    )
}
